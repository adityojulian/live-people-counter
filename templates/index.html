<!DOCTYPE html>
<html>
	<head>
		<title>People Counter Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='css/style.css') }}"
		/>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row mb-3">
				<div class="col">
					<div class="controls">
						<a href="/setup-polygons" class="btn btn-primary"
							>Setup Counting Zones</a
						>
						<!-- <button id="startBtn" class="btn btn-success">Start</button>
						<button id="stopBtn" class="btn btn-danger">Stop</button> -->
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-8">
					<div class="video-container">
						<!-- Add loading container -->
						<div id="loadingContainer" class="loading-container">
							<div class="spinner-border loading-spinner" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
							<p class="loading-text">Connecting to stream...</p>
							<p id="streamError" class="stream-error">
								Failed to connect to stream. Please refresh the page.
							</p>
						</div>
						<img
							id="videoFeed"
							class="video-feed"
							src="/video_feed"
							style="display: none"
						/>
					</div>
				</div>
				<div class="col-md-4">
					<div id="stats-container"></div>
				</div>
			</div>
		</div>

		<script>
            // State management
            const STATE = {
                LOADING: 'loading',
                CONNECTED: 'connected',
                ERROR: 'error'
            };
        
            // UI Elements
            const videoFeed = document.getElementById("videoFeed");
            const loadingContainer = document.getElementById("loadingContainer");
            const streamError = document.getElementById("streamError");
            const loadingSpinner = document.querySelector(".loading-spinner");
            const loadingText = document.querySelector(".loading-text");
        
            let currentState = STATE.LOADING;
        
            function updateUIState(state) {
                currentState = state;
                switch (state) {
                    case STATE.LOADING:
                        loadingContainer.style.display = "block";
                        loadingSpinner.style.display = "block";
                        loadingText.style.display = "block";
                        streamError.style.display = "none";
                        videoFeed.style.display = "none";
                        break;
                    case STATE.CONNECTED:
                        loadingContainer.style.display = "none";
                        videoFeed.style.display = "block";
                        break;
                    case STATE.ERROR:
                        loadingContainer.style.display = "block";
                        loadingSpinner.style.display = "none";
                        loadingText.style.display = "none";
                        streamError.style.display = "block";
                        videoFeed.style.display = "none";
                        break;
                }
            }
        
            // Check stream status before showing video
            function checkStreamStatus() {
                fetch('/video_feed', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            videoFeed.src = '/video_feed';
                        } else {
                            throw new Error('Stream not ready');
                        }
                    })
                    .catch(error => {
                        console.error('Stream error:', error);
                        updateUIState(STATE.ERROR);
                    });
            }
        
            // Add load event listener to video feed
            videoFeed.onload = function () {
                updateUIState(STATE.CONNECTED);
            };
        
            // Add error handling for video feed
            videoFeed.onerror = function () {
                updateUIState(STATE.ERROR);
                // Retry connection after 5 seconds
                setTimeout(checkStreamStatus, 5000);
            };
        
            // Initial stream check
            checkStreamStatus();
        
            // Stats update with error handling
            function updateStats() {
                fetch("/stats")
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.json();
                    })
                    .then(stats => {
                        const container = document.getElementById("stats-container");
                        container.innerHTML = "";
        
                        Object.entries(stats).forEach(([id, zone]) => {
                            container.innerHTML += `
                                <div class="stats-card">
                                    <h4>${zone.name}</h4>
                                    <p>Entries: ${zone.entry}</p>
                                    <p>Exits: ${zone.exit}</p>
                                    <p>Current: ${zone.current}</p>
                                </div>
                            `;
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching stats:", error);
                        if (currentState === STATE.LOADING) {
                            updateUIState(STATE.ERROR);
                        }
                    });
            }
        
            // // Start/Stop controls with state management
            // document.getElementById("startBtn").addEventListener("click", () => {
            //     updateUIState(STATE.LOADING);
            //     fetch("/start", { method: "POST" })
            //         .then(response => response.json())
            //         .then(data => {
            //             console.log(data.message);
            //             checkStreamStatus();
            //         })
            //         .catch(error => {
            //             console.error("Error starting process:", error);
            //             updateUIState(STATE.ERROR);
            //         });
            // });
        
            // document.getElementById("stopBtn").addEventListener("click", () => {
            //     fetch("/stop", { method: "POST" })
            //         .then(response => response.json())
            //         .then(data => {
            //             console.log(data.message);
            //             updateUIState(STATE.LOADING);
            //         })
            //         .catch(error => {
            //             console.error("Error stopping process:", error);
            //         });
            // });
        
            // Update stats periodically
            setInterval(updateStats, 1000);
        </script>
	</body>
</html>

<!-- // Example frontend code
fetch('/history?zone_id=1&start_time=2024-03-06T00:00:00&end_time=2024-03-06T23:59:59')
  .then(response => response.json())
  .then(data => {
    // Process historical data
    console.log(data);
  }); -->
