<!DOCTYPE html>
<html>
	<head>
		<title>Setup Counting Zones</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<style>
			.canvas-container {
				position: relative;
				margin: 20px 0;
				display: inline-block;
			}
			.video-feed {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 0;
			}
			canvas {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
			}
			.controls {
				margin: 10px 0;
			}
			.zones-list {
				max-height: 400px;
				overflow-y: auto;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-9">
					<div class="controls">
						<button id="newZoneBtn" class="btn btn-primary">New Zone</button>
						<button id="completeZoneBtn" class="btn btn-success" disabled>
							Complete Zone
						</button>
						<button id="cancelZoneBtn" class="btn btn-warning" disabled>
							Cancel Drawing
						</button>
						<a href="/" class="btn btn-secondary">Back</a>
					</div>

					<div class="canvas-container">
						<img id="videoFeed" class="video-feed" src="/setup-feed" />
						<canvas id="setupCanvas"></canvas>
					</div>
				</div>

				<div class="col-md-3">
					<div class="card">
						<div class="card-header">
							<h5 class="mb-0">Zones</h5>
						</div>
						<div class="card-body zones-list" id="zonesList">
							<!-- Zone items will be added here -->
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const canvas = document.getElementById('setupCanvas');
			const ctx = canvas.getContext('2d');
			const videoFeed = document.getElementById('videoFeed');

			let currentZone = [];
			let zones = JSON.parse('{{ existing_zones|tojson|safe }}') || [];
			let isDrawing = false;

			// Set canvas size to match video feed
			videoFeed.onload = function() {
			    canvas.width = videoFeed.offsetWidth;
			    canvas.height = videoFeed.offsetHeight;
			    updateZonesList();
			};

			function updateZonesList() {
			    const container = document.getElementById('zonesList');
			    container.innerHTML = zones.map((zone, index) => `
			        <div class="card mb-2">
			            <div class="card-body p-2">
			                <div class="d-flex justify-content-between align-items-center">
			                    <input type="text" class="form-control form-control-sm me-2"
			                           value="${zone.name}"
			                           onchange="updateZoneName(${index}, this.value)">
			                    <button class="btn btn-danger btn-sm"
			                            onclick="deleteZone(${index})">
			                        <i class="bi bi-trash"></i>
			                    </button>
			                </div>
			            </div>
			        </div>
			    `).join('');
			}

			// Add to setup_polygons.html
			function showNotification(message, type = 'success') {
				const alertDiv = document.createElement('div');
				alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
				alertDiv.role = 'alert';
				alertDiv.innerHTML = `
					${message}
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				`;

				document.querySelector('.container-fluid').insertBefore(
					alertDiv,
					document.querySelector('.row')
				);

				setTimeout(() => alertDiv.remove(), 5000);  // Remove after 5 seconds
			}

			// Update the saveZones function
			function saveZones() {
				// Format zones data to match backend expectations
				const zonesData = zones.map(zone => ({
					name: zone.name,
					points: Array.isArray(zone.points) ? zone.points : []  // Ensure points is an array
				}));

				console.log('Sending zones data:', zonesData);  // Debug log

				fetch('/zones', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(zonesData)
				})
				.then(response => response.json())
				.then(data => {
					if (data.status === 'success') {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						updateZonesList();
						showNotification('Zones updated successfully');
					} else {
						showNotification(data.message || 'Error saving zones', 'danger');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					showNotification('Error saving zones: ' + error, 'danger');
				});
			}

			function deleteZone(index) {
				zones = zones.filter((_, i) => i !== index);  // Create new array without deleted zone
				saveZones();
			}

			function updateZoneName(index, name) {
				zones[index] = { ...zones[index], name };  // Create new zone object with updated name
				saveZones();
			}

			canvas.addEventListener('click', function(e) {
			    if (!isDrawing) return;

			    const rect = canvas.getBoundingClientRect();
			    const x = e.clientX - rect.left;
			    const y = e.clientY - rect.top;

			    currentZone.push({x, y});
			    drawCurrentZone();

			    document.getElementById('completeZoneBtn').disabled = currentZone.length < 3;
			});

			document.getElementById('newZoneBtn').addEventListener('click', () => {
			    isDrawing = true;
			    currentZone = [];
			    document.getElementById('completeZoneBtn').disabled = true;
			    document.getElementById('cancelZoneBtn').disabled = false;
			    document.getElementById('newZoneBtn').disabled = true;
			});

			document.getElementById('completeZoneBtn').addEventListener('click', () => {
			    if (currentZone.length >= 3) {
			        zones.push({
			            points: currentZone,
			            name: `Zone ${zones.length + 1}`
			        });
			        saveZones();

			        currentZone = [];
			        isDrawing = false;
			        document.getElementById('newZoneBtn').disabled = false;
			        document.getElementById('completeZoneBtn').disabled = true;
			        document.getElementById('cancelZoneBtn').disabled = true;
			        ctx.clearRect(0, 0, canvas.width, canvas.height);
			    }
			});

			document.getElementById('cancelZoneBtn').addEventListener('click', () => {
			    currentZone = [];
			    isDrawing = false;
			    document.getElementById('newZoneBtn').disabled = false;
			    document.getElementById('completeZoneBtn').disabled = true;
			    document.getElementById('cancelZoneBtn').disabled = true;
			    ctx.clearRect(0, 0, canvas.width, canvas.height);
			});

			function drawCurrentZone() {
			    ctx.clearRect(0, 0, canvas.width, canvas.height);

			    if (currentZone.length > 0) {
			        // Draw points
			        currentZone.forEach((point, index) => {
			            ctx.beginPath();
			            ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
			            ctx.fillStyle = '#ff0000';
			            ctx.fill();

			            // Draw point number
			            ctx.fillStyle = '#ffffff';
			            ctx.fillRect(point.x + 10, point.y - 20, 30, 20);
			            ctx.fillStyle = '#000000';
			            ctx.font = '12px Arial';
			            ctx.fillText(index + 1, point.x + 15, point.y - 5);
			        });

			        // Draw lines
			        ctx.beginPath();
			        ctx.moveTo(currentZone[0].x, currentZone[0].y);
			        currentZone.slice(1).forEach(point => {
			            ctx.lineTo(point.x, point.y);
			        });
			        ctx.strokeStyle = '#00ff00';
			        ctx.lineWidth = 2;
			        ctx.stroke();
			    }
			}
		</script>
	</body>
</html>